/* Random Book Finder, version [0.0.4a-r2]
Originally from: http://en.wikibooks.org/wiki/User:Splarka/randbook.js
Based roughly on http://en.wikibooks.org/w/index.php?title=MediaWiki:RandomBook.js&oldid=1209572 by Darklama.

Grabs 10 random pages from the API, checks if any are books. Repeats until it finds a book.

Notes:
* Don't try to grab more than 10 random pages, callback is limited to 10 at a time.
* As 10.5% of pages are books, most queries should take no more than 2 iterations.
* Setting window.location.href eats history in some browsers.
* curid point to the correct book even if the book title is renamed in the mean time.
* To append links instead use: var randBookAsLink = true; (users can set this in their monobook individually too);
*/

var randBookAsLink = false;
var rburl = wgServer + wgScriptPath + '/api.php?action=query&indexpageids=1&generator=random&grnnamespace=0|110&grnlimit=10&prop=categories&cllimit=100&format=json&requestid=rb';
var rbcb = '&callback=?';
var rbrqid = 0;

function showRandBook() {
	if (window.randBookAsLink) {
		$('#n-randbook').append(
			'<img id="mw-spinner-randbook" title="..." alt="..." src="' + stylepath + '/common/images/spinner.gif' + '" />'
		);
	}

	$.getJSON(rburl+rbrqid+rbcb, showRandBookCB);
	rbrqid++;
	return true;
}

function showRandBookCB(obj) {
	if (!obj['query'] || !obj['query']['pages'] || !obj['query']['pageids']) {
		$('#n-randbook').append('<span class="error">error</span>');
		if ( window.randBookAsLink ) {
			$('#mw-spinner-randbook').remove();
		}
		return false;
	}

	var id = obj['query']['pageids'];
	var found;
	for (var i=0;i<id.length;i++) {
		var cats = obj['query']['pages'][id[i]]['categories'];
		if (!cats) continue;
		for (var j=0;j<cats.length;j++) {
			var ct = cats[j]['title'];
				if (ct.indexOf('Category:Alphabetical/') == 0) {
					found = obj['query']['pages'][id[i]];
					break;
				}
		}
		if (found) break;
	}

	if ( !found ) {
		// didn't find any, try again
		$j.getJSON(rburl+rbrqid+rbcb, showRandBookCB);
		rbrqid++;
	} else {
		var link = wgServer + wgScript + '?curid=' + found['pageid'];

		if ( window.randBookAsLink ) {
			$('#mw-spinner-randbook').remove();
			$('#n-randbook').append('<div><a href="' + link + '"> \u2022\u00A0' + found['title'] + '</a></div>');
		} else if (window.location.assign) {
			window.location.assign(link);
		} else {
			window.location.href = link; 
		}
	}
	return true;
}

function showRandBookLink() {
	mw.util.updateTooltipAccessKeys
	(
		$('#p-Navigation')
			.find('ul')
			.append( $("<li id='n-randbook'><a href='#' title='Show me a random book! [x]' accesskey='x'>Random book</a></li>") )
			.find('#n-randbook').click(showRandBook)
	);
}

$(document).ready(showRandBookLink);